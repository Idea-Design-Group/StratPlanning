@model Application.DTOs.PlanStepDTO
@using Resources

@using Web.Helpers

@{
    var stepList = StepHelper.GetStepList(Context);

    var count = 0;
    var stepTaskCount = 0;
}

<div class="m-portlet m-portlet--bordered m-portlet--unair m--margin-top-30">
    <div class="m-portlet__head">
        <div class="m-portlet__head-caption">
            <div class="row no-gutters justify-content-md-center">
                <div class="col col-lg-12">
                    <h3 class="m-portlet__head-text">
                        Steps
                    </h3>
                </div>
            </div>
        </div>
        @*<a href="#" data-target="#help_modal_steptasks" data-toggle="modal"
               class="m-portlet__nav-link btn btn-lg btn-secondary  m-btn m-btn--icon m-btn--icon-only m-btn--pill  m-dropdown__toggle m-intro__help">
                <i class="fa fa-question"></i>
            </a>*@
    </div>
    <div class="m-portlet__body">

        <div class="form-group m-form__group">
            <div class="row">
                <label class="col-form-label col-sm-12">
                    What steps will you use in your planning process?
                </label>
            </div>
            <div class="m-scrollable " data-scrollable="true" data-axis="xy">
                <table class="table m-table  table-bordered m--margin-top-10" width="100%">
                    <thead>
                        <tr>
                            <th>
                                Steps / tasks
                            </th>
                            <th>
                                External users
                                @*Persons / groups involved*@
                            </th>
                            @if (Model.IsAdmin)
                            {
                                <th>
                                    Schedule
                                </th>
                                <th>
                                    Remind in (days)
                                </th>
                                <th>
                                    Completed
                                </th>
                                <th>
                                    Status
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>

                        @foreach (var stepTask in Model.StepTasks)
                        {
                            var stepTaskAnswers = Model.StepTaskAnswers?.Answer?.StepTaskAnswers.Where(x => x.Step == stepTask.Step) ?? Enumerable.Empty<StepTaskAnswerDTO>();

                            <tr>
                                <td rowspan="2">
                                    <input asp-for="StepTasks[stepTaskCount].Id" type="hidden" />
                                    @steps.ResourceManager.GetString(stepTask.Step)
                                </td>
                                <td>
                                    <div class="m-list-badge m-list-badge--light-bg">
                                        <div class="m-list-badge__items">
                                            @{
                                                if (!Model.IsAdmin)
                                                {
                                                    var definitiveAnswers = Model.StepTaskAnswers?.DefinitiveAnswer?.StepTaskAnswers.Where(x => x.Step == stepTask.Step) ?? Enumerable.Empty<StepTaskAnswerDTO>();

                                                    foreach (var definitiveAnswer in definitiveAnswers)
                                                    {
                                                        <span class="m-list-badge__item m-list-badge__item--warning">
                                                            @definitiveAnswer.FirstName @definitiveAnswer.LastName (@definitiveAnswer.Email)
                                                        </span>
                                                    }
                                                }

                                                var otherAnswers = Model.StepTaskAnswers?.OtherAnswers ?? Enumerable.Empty<AnswerDTO>();

                                                foreach (var otherAnswer in otherAnswers)
                                                {
                                                    var otherStepTaskAnswers = otherAnswer.StepTaskAnswers.Where(x => x.Step == stepTask.Step) ?? Enumerable.Empty<StepTaskAnswerDTO>();

                                                    foreach (var stepTaskAnswer in otherStepTaskAnswers)
                                                    {
                                                        <span title="@otherAnswer.Author"
                                                              data-toggle="tooltip"
                                                              class="m-list-badge__item m-list-badge__item--default sp-tooltip">
                                                            @stepTaskAnswer.FirstName @stepTaskAnswer.LastName (@stepTaskAnswer.Email)
                                                        </span>
                                                    }
                                                }
                                            }
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="m-list-badge m-list-badge--light-bg">
                                        <div class="m-list-badge__items list-items" id="step_tasks_list_@stepTask.Step">
                                            @foreach (var stepTaskAnswer in stepTaskAnswers)
                                            {
                                                <a class="m-list-badge__item m-list-badge__item--default list-item">
                                                    <input type="hidden" asp-for="StepTaskAnswers.Answer.StepTaskAnswers[count].Id" value="@stepTaskAnswer.Id" />
                                                    <input type="hidden" name="StepTaskAnswers.Answer.StepTaskAnswers.Index" value="@count" />
                                                    @stepTaskAnswer.FirstName @stepTaskAnswer.LastName (@stepTaskAnswer.Email)
                                                    <span class="list-item-delete fa fa-close"></span>
                                                </a>
                                                count++;
                                            }
                                        </div>
                                    </div>
                                    @if (Model.IsAdmin || !Model.IsSubmitted)
                                    {
                                        <a href="" class="btn btn-sp m-btn m-btn--pill m--pull-right"
                                           data-toggle="modal" data-target="#edit_steptasks_modal" data-step="@stepTask.Step">
                                            Add new
                                        </a>
                                    }
                                </td>
                                @if (Model.IsAdmin)
                                {
                                    <td rowspan="2">
                                        <input type="text" asp-for="StepTasks[stepTaskCount].Schedule" class="datepicker form-control" />
                                    </td>
                                    <td rowspan="2">
                                        <input type="text" asp-for="StepTasks[stepTaskCount].RemindIn" class="form-control" />
                                    </td>
                                    <td rowspan="2">
                                        <i class="fa fa-check-square-o sp-font-md"></i>
                                    </td>
                                    <td rowspan="2">
                                        @{ 
                                            var statusClass = "";

                                            switch (stepTask.Status)
                                            {
                                                case StepTaskStatus.Completed: statusClass = "fa-check m--font-success"; break;
                                                case StepTaskStatus.Uncompleted: statusClass = ""; break;
                                                case StepTaskStatus.OverdueCompleted: statusClass = "fa-warning m--font-warning"; break;
                                                case StepTaskStatus.OverdueUnCompleted: statusClass = "fa-remove m--font-danger"; break;
                                            }
                                        }
                                        <span class="fa @statusClass">
                                        </span>
                                    </td>
                                }

                            </tr>
                            stepTaskCount++;
                        }
                    </tbody>
                </table>
                <input type="hidden" name="count" id="step_tasks_count" value="@count" />
            </div>
            <span class="m-form__help">
                Review these steps with the people who are involved, and refine them as
                needed.
            </span>
        </div>
    </div>
</div>
